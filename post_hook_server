#!/usr/bin/env python
# -*- coding: utf-8 -*-
import logging
import logging.config
import os, sys
import daemon.runner

path = os.path.dirname(os.path.abspath(__file__))
os.chdir(path)
#from bin import post_server

logging.config.fileConfig('etc/logging.conf')
logger = logging.getLogger('main')

class post_hook():
    def __init__(self):
        self.stdin_path       = "/dev/null"
        self.stdout_path      = "/dev/tty"
        self.stderr_path      = "/dev/tty"
        self.pidfile_path     = os.path.abspath("/var/run/post_hook.pid")
        self.pidfile_timeout  = 5

    def run(self):
        try:
            # We need to import post_server here to resolve file descriptor issue
            # http://stackoverflow.com/questions/20636678/paramiko-inside-python-daemon-causes-ioerror?rq=1
            os.chdir(path)
            from bin import post_server
            post_server.main()
        except SystemExit:
            logger.info("post_hook system stopped.")
            print "post_hook system stopped."


if __name__ == '__main__':
    if len(sys.argv) == 2:
        try:
            post_hook = post_hook()
            runner = daemon.runner.DaemonRunner(post_hook)

            runner.daemon_context.files_preserve=[logger.handlers[0].stream]
            runner.do_action()
        except:
            logger.error("Daemon error", exc_info=True)
            print "Daemon stopped"
    else:
        print "Usage: %s start|stop|restart" % sys.argv[0]
        sys.exit(1)
else:
    print "This cannot be included in another program"
